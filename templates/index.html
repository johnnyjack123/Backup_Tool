<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Backup Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #353536;
            color: #e0e0e0;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #2c2c2c;
            border-radius: 1rem;
        }
        .btn-outline-success, .btn-outline-danger {
            border-width: 2px;
        }
        .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .form-control {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }
        .form-control:focus {
            background-color: #2a2a2a;
            color: #fff;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Backup Status</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('settings_page') }}" class="btn btn-outline-success">Settings</a>
        </div>
    </div>

    <div class="d-flex justify-content-start mb-4">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBackupModal">
            Neues Backup hinzufügen
        </button>
    </div>

    <!-- Bereich für Backups -->
    <div id="backupContainer" class="row g-3"></div>
</div>

<!-- Modal mit Formular -->
<div class="modal fade" id="addBackupModal" tabindex="-1" aria-labelledby="addBackupLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('create_backup_task') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBackupLabel">Create new backup rule</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="backupName">Name</label>
                        <input type="text" class="form-control" id="backupName" name="name"
                               placeholder="Choose a unique name" required>
                        <div id="nameError" class="form-text text-danger" style="display:none;">Name already exists!</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="backupPath">Path to the folder which is going to back up.</label>
                        <input type="text" class="form-control" id="backupPath" name="folder_to_backup"
                               placeholder="Copy path" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="backupSavePath">Path to the folder where the backup is going to be stored.</label>
                        <input type="text" class="form-control" id="backupSavePath" name="folder_to_save_backup"
                               placeholder="Copy path" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="backupFrequency">Backup frequency in hours</label>
                        <input type="number" class="form-control" id="backupFrequency" name="backup_frequency" min="1" step="1" required
                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value < 1) this.value = 1;"
                               placeholder="Only values larger than 1 possible">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abort</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deine restlichen Modals und Scripts bleiben unverändert -->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Dein bestehendes JavaScript bleibt gleich -->
</body>
</html>

<!-- Edit Modal -->
<div class="modal fade" id="editBackupModal" tabindex="-1" aria-labelledby="editBackupLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('edit_backup_task') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBackupLabel">Edit Backup Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <!-- Name readonly oder hidden im Formular -->
                    <input type="hidden" id="originalName" name="original_name">
                    <div class="mb-3">
                        <label for="editBackupName" class="form-label">Name (nicht änderbar)</label>
                        <input type="text" id="editBackupName" class="form-control" name="name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupPath" class="form-label">Path to the folder which is going to back up.</label>
                        <input type="text" id="editBackupPath" class="form-control" name="folder_to_backup" required>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupSavePath" class="form-label">Path to the folder where the backup is going to be stored.</label>
                        <input type="text" id="editBackupSavePath" class="form-control" name="folder_to_save_backup" required>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupFrequency" class="form-label">Backup frequency in hours</label>
                        <input
                            type="number"
                            class="form-control"
                            id="editBackupFrequency"
                            name="backup_frequency"
                            min="1"
                            step="1"
                            required
                            oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value < 1) this.value = 1;">
                    </div>
                    <input type="hidden" id="editBackupId" name="backup_id">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" action="{{ url_for('delete_backup_task') }}" method="POST">
                <input type="hidden" id="deleteBackupName" name="name">
                <input type="hidden" id="deleteBackupId" name="backup_id">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmLabel">Delete Backup Process</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure to delete the backup process <strong id="deleteBackupNameText"></strong>? All of your existing version created by this process are still storaged on your device after this action. This action can´t be undone.</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abort</button>
                    <button type="submit" class="btn btn-danger">Yes, delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="toggleProcessForm" action="{{ url_for('toggle_process_status') }}" method="POST" style="display:none;">
  <input type="hidden" id="toggleProcessName" name="name">
</form>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Backup Anzeige Script -->
<script>

    const backupArray = {{ backup_paths | tojson }};
    const container = document.getElementById('backupContainer');

    // Key Replacement Mapping (kannst du erweitern)
const keyReplacements = {
    'folder_to_backup': 'Folder to save',
    'folder_to_save_backup': 'Folder to store',
    'backup_frequency': 'Backup frequency in hours',
    'last_backup': 'Last Backup',
    'status': 'Status',
    'status_message': 'Status Message'
};

// Backup Karten erzeugen mit keyReplacement
backupArray.forEach(entry => {
    const card = document.createElement('div');
    card.classList.add('col-md-6', 'col-lg-4');
    const cardBody = document.createElement('div');
    cardBody.classList.add('card', 'shadow-sm');

    const header = document.createElement('div');
header.classList.add('card-header', 'bg-primary', 'text-white', 'fw-bold', 'd-flex', 'justify-content-between', 'align-items-center');

const titleSpan = document.createElement('span');
titleSpan.textContent = entry.name ? entry.name : 'Unbenanntes Backup';

const deleteBtn = document.createElement('button');
deleteBtn.type = 'button';
deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
deleteBtn.innerHTML = 'Delete'; // Oder 'Löschen' oder Icon
deleteBtn.title = 'Delete';
deleteBtn.addEventListener('click', () => {
    document.getElementById('deleteBackupName').value = entry.name;
    document.getElementById('deleteBackupNameText').textContent = entry.name;

    document.getElementById('deleteBackupId').value = entry.backup_id || '';

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
});

// innerhalb der backupArray.forEach Schleife, nach deleteBtn
const toggleBtn = document.createElement('button');
toggleBtn.type = 'button';
toggleBtn.classList.add('btn', 'btn-warning', 'btn-sm', 'm-1'); // Styling
// Setze den Text je nach Status
toggleBtn.textContent = (entry.status === 'paused') ? 'Continue' : 'Pause';

// Event: beim Klick wird Route aufgerufen, Name im hidden input
toggleBtn.addEventListener('click', () => {
    // Hidden input mit Namen befüllen
    document.getElementById('toggleProcessName').value = entry.name;
    // Formular absenden (z.B. per POST zu /toggle_process)
    document.getElementById('toggleProcessForm').submit();
});

header.appendChild(titleSpan);

header.appendChild(toggleBtn);
header.appendChild(deleteBtn);

    const ul = document.createElement('ul');
    ul.classList.add('list-group', 'list-group-flush');

    for (const [key, value] of Object.entries(entry)) {
    if (key === 'name') continue;
    if (key === 'backup_id') continue;


    const li = document.createElement('li');
    li.classList.add('list-group-item');

    const replacedKey = keyReplacements[key] || key;

    if (key === 'last_backup') {
        li.id = `last_backup-${entry.name}`;
        li.innerHTML = `<strong>${replacedKey}:</strong> <em>Loading...</em>`;
    } else if (key === 'status') {
        // Status Badge mit Farben
        let badgeClass = 'bg-secondary';
        if (value === 'running') badgeClass = 'bg-success';
        else if (value === 'paused') badgeClass = 'bg-warning';
        else if (value === 'stopped') badgeClass = 'bg-danger';

        li.innerHTML = `<strong>${replacedKey}:</strong> <span class="badge ${badgeClass}">${value}</span>`;
    } else if (replacedKey.toLowerCase().includes('status')) {
        // Status-Message Badge
        let badgeClass = (value.toLowerCase() === 'ok') ? 'bg-success' : 'bg-danger';
        li.innerHTML = `<strong>${replacedKey}:</strong> <span class="badge ${badgeClass}">${value}</span>`;
    } else {
        li.innerHTML = `<strong>${replacedKey}:</strong> ${value}`;
    }

    ul.appendChild(li);
}

    cardBody.appendChild(header);
    cardBody.appendChild(ul);

    // Edit-Button für dieses Backup erzeugen
    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.classList.add('btn', 'btn-outline-primary', 'm-3');
    editBtn.textContent = 'Edit';

    // Event Listener mit spezifischem entry
    editBtn.addEventListener('click', () => {
    document.getElementById('editBackupName').value = entry.name;
    document.getElementById('editBackupPath').value = entry.folder_to_backup || '';
    document.getElementById('editBackupSavePath').value = entry.folder_to_save_backup || '';
    document.getElementById('editBackupFrequency').value = entry.backup_frequency || '';
    document.getElementById('originalName').value = entry.name;

    document.getElementById('editBackupId').value = entry.backup_id || '';

    const editModal = new bootstrap.Modal(document.getElementById('editBackupModal'));
    editModal.show();
});


    cardBody.appendChild(editBtn);
    card.appendChild(cardBody);
    container.appendChild(card);
});



// Live Validierung für eindeutigen Namen im Formular
const nameInput = document.getElementById('backupName');
const nameError = document.getElementById('nameError');
const submitButton = document.querySelector('form button[type="submit"]');

nameInput.addEventListener('input', () => {
    const enteredName = nameInput.value.trim().toLowerCase();
    const nameExists = backupArray.some(entry => entry.name && entry.name.toLowerCase() === enteredName);

    if (nameExists) {
        nameError.style.display = 'block';
        submitButton.disabled = true;
    } else {
        nameError.style.display = 'none';
        submitButton.disabled = false;
    }
});


    const socket = io();

    socket.on('status_update', (data) => {
        console.log("Status Update:", data);

        // Beispiel: Statusfeld in Backup-Karte aktualisieren (du müsstest pro Backup eine Statusanzeige mit einer ID o.ä. anlegen)
        const statusElement = document.querySelector(`#status-${data.name}`);
        if (statusElement) {
            statusElement.textContent = data.status;
        }
    });

    socket.on('backup_time_update', (backupTimes) => {
        console.log("Received backup_time_update:", backupTimes);

    backupTimes.forEach(data => {
        const lastBackupElement = document.getElementById(`last_backup-${data.name}`);
        if (lastBackupElement) {
            lastBackupElement.innerHTML = `<strong>${keyReplacements['last_backup']}:</strong> ${data.last_backup || "<em>Keine Daten</em>"}`;
        }
    });
});



</script>
</body>
</html>
