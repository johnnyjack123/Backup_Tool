<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Backup Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="mb-4">Backup Status</h1>

    <!-- Button zum Öffnen des Modals -->
    <button type="button" class="btn btn-success mb-4" data-bs-toggle="modal" data-bs-target="#addBackupModal">
        Neues Backup hinzufügen
    </button>

    <!-- Bereich für Backups -->
    <div id="backupContainer" class="row g-3"></div>
</div>

<!-- Modal mit Formular -->
<div class="modal fade" id="addBackupModal" tabindex="-1" aria-labelledby="addBackupLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('create_backup_task') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBackupLabel">Create new backup rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="backupName">Name</label>
                        <input type="text" class="form-control" id="backupName" name="name"
                               placeholder="Choose a unique name" required>
                        <div id="nameError" class="form-text text-danger" style="display:none;">Name already exists!
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="backupPath">Path to the folder which is going to back up.</label>
                        <input type="text" class="form-control" id="backupPath" name="folder_to_backup"
                               placeholder="Copy path" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="backupSavePath">Path to the folder where the backup is going to
                            be stored.</label>
                        <input type="text" class="form-control" id="backupSavePath" name="folder_to_save_backup"
                               placeholder="Copy path"
                               required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="backupFrequency">Backup frequency in hours</label>
                        <input
                                type="number"
                                class="form-control"
                                id="backupFrequency"
                                name="backup_frequency"
                                min="1"
                                step="1"
                                required
                                oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value < 1) this.value = 1;"
                                placeholder="Only values larger than 1 possible">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abort</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editBackupModal" tabindex="-1" aria-labelledby="editBackupLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('edit_backup_task') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBackupLabel">Edit Backup Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <!-- Name readonly oder hidden im Formular -->
                    <input type="hidden" id="originalName" name="original_name">
                    <div class="mb-3">
                        <label for="editBackupName" class="form-label">Name (nicht änderbar)</label>
                        <input type="text" id="editBackupName" class="form-control" name="name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupPath" class="form-label">Path to the folder which is going to back up.</label>
                        <input type="text" id="editBackupPath" class="form-control" name="folder_to_backup" required>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupSavePath" class="form-label">Path to the folder where the backup is going to be stored.</label>
                        <input type="text" id="editBackupSavePath" class="form-control" name="folder_to_save_backup" required>
                    </div>
                    <div class="mb-3">
                        <label for="editBackupFrequency" class="form-label">Backup frequency in hours</label>
                        <input
                            type="number"
                            class="form-control"
                            id="editBackupFrequency"
                            name="backup_frequency"
                            min="1"
                            step="1"
                            required
                            oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value < 1) this.value = 1;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Backup Anzeige Script -->
<script>
    const backupArray = {{ backup_paths | tojson }};
    const container = document.getElementById('backupContainer');

    // Key Replacement Mapping (kannst du erweitern)
const keyReplacements = {
    'folder_to_backup': 'Folder to save',
    'folder_to_save_backup': 'Folder to store',
    'backup_frequency': 'Backup frequency',
    'last_backup': 'Last Backup',
    'status': 'Status'
};

// Backup Karten erzeugen mit keyReplacement
backupArray.forEach(entry => {
    const card = document.createElement('div');
    card.classList.add('col-md-6', 'col-lg-4');
    const cardBody = document.createElement('div');
    cardBody.classList.add('card', 'shadow-sm');

    const header = document.createElement('div');
    header.classList.add('card-header', 'bg-primary', 'text-white', 'fw-bold');
    header.textContent = entry.name ? entry.name : 'Unbenanntes Backup';

    const ul = document.createElement('ul');
    ul.classList.add('list-group', 'list-group-flush');

    for (const [key, value] of Object.entries(entry)) {
        if (key === 'name') continue;
        const li = document.createElement('li');
        li.classList.add('list-group-item');

        const replacedKey = keyReplacements[key] || key;
        li.innerHTML = `<strong>${replacedKey}:</strong> ${value}`;
        ul.appendChild(li);
    }

    cardBody.appendChild(header);
    cardBody.appendChild(ul);

    // Edit-Button für dieses Backup erzeugen
    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.classList.add('btn', 'btn-outline-primary', 'm-3');
    editBtn.textContent = 'Editieren';

    // Event Listener mit spezifischem entry
    editBtn.addEventListener('click', () => {
        document.getElementById('editBackupName').value = entry.name;
        document.getElementById('editBackupPath').value = entry.folder_to_backup || '';
        document.getElementById('editBackupSavePath').value = entry.folder_to_save_backup || '';
        document.getElementById('editBackupFrequency').value = entry.backup_frequency || '';

        document.getElementById('originalName').value = entry.name;

        const editModal = new bootstrap.Modal(document.getElementById('editBackupModal'));
        editModal.show();
    });

    cardBody.appendChild(editBtn);
    card.appendChild(cardBody);
    container.appendChild(card);
});



// Live Validierung für eindeutigen Namen im Formular
const nameInput = document.getElementById('backupName');
const nameError = document.getElementById('nameError');
const submitButton = document.querySelector('form button[type="submit"]');

nameInput.addEventListener('input', () => {
    const enteredName = nameInput.value.trim().toLowerCase();
    const nameExists = backupArray.some(entry => entry.name && entry.name.toLowerCase() === enteredName);

    if (nameExists) {
        nameError.style.display = 'block';
        submitButton.disabled = true;
    } else {
        nameError.style.display = 'none';
        submitButton.disabled = false;
    }
});

</script>
</body>
</html>
